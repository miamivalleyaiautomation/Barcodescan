<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>ScanSnap â€¢ iOS Scanner (1D + 2D)</title>

<!-- 1D: Quagga2 -->
<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.4/dist/quagga.js"></script>
<!-- 2D: ZXing -->
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://unpkg.com/@zxing/browser@latest"></script>

<style>
  :root{--bg:#0b1020;--card:#11172b;--text:#e9ecf1;--muted:#aab2c7;--primary:#4fb3ff;--danger:#ff5c7a;--good:#2ecc71;--border:#1f2a45}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,system-ui,Inter,Roboto,Arial}
  .top{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px 16px;background:#0f1527;border-bottom:1px solid var(--border)}
  .brand{font-weight:800}
  .btn{border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn--p{background:var(--primary);color:#001c2b} .btn--d{background:var(--danger);color:#2b0007}
  .chip{background:#18223d;padding:6px 10px;border-radius:999px}
  .wrap{display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:16px;max-width:1100px;margin:0 auto}
  @media (max-width:900px){.wrap{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:0 12px 30px rgba(0,0,0,.25)}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:8px 0}
  h3{margin:6px 0 10px}
  .control{background:#0d1429;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 10px;min-width:160px}
  .subtle{color:var(--muted);font-size:14px}
  .chips{display:flex;flex-wrap:wrap;gap:6px}
  .chip-inp{background:#15223d;padding:6px 8px;border-radius:999px}
  .video-card{background:#000;border-radius:12px;overflow:hidden;border:1px solid var(--border);position:relative}
  .viewport{width:100%;height:clamp(220px,38vh,420px);display:block}
  .overlay{position:absolute;inset:0;pointer-events:none}
  .trigger{position:absolute;left:0;right:0;bottom:0;display:flex;gap:10px;align-items:center;justify-content:center;padding:10px;background:linear-gradient(180deg,transparent,rgba(0,0,0,.55));border-top:1px solid rgba(255,255,255,.08);backdrop-filter:saturate(1.2) blur(6px)}
  .armed{display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border:1px solid rgba(46,204,113,.4);background:rgba(46,204,113,.15);border-radius:999px;font-weight:700;letter-spacing:.3px;color:var(--good)}
  .badge{background:#15223f;border:1px solid var(--border);border-radius:10px;padding:8px 10px}
  .results{display:grid;gap:6px}
  .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:10px}
  table{width:100%;border-collapse:collapse;background:#0d1429}
  th,td{border-bottom:1px solid var(--border);padding:10px 12px;white-space:nowrap}
  thead th{position:sticky;top:0;background:#0f1527;text-align:left;font-size:12px;color:var(--muted)}
  .center{text-align:center}
  .status{margin:8px 0;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0d1429;font-size:13px;color:var(--muted)}
  .status--ok{border-color:rgba(46,204,113,.3);color:#9fe1b8}
  .status--err{border-color:rgba(255,92,122,.35);color:#ffb5c3}
</style>
</head>
<body>
<header class="top">
  <div class="brand">ðŸ“· ScanSnap â€¢ iOS Scanner (1D + 2D)</div>
  <div class="row">
    <button id="permBtn" class="btn">Permission</button>
    <button id="refreshBtn" class="btn">Refresh Cameras</button>
    <button id="startBtn" class="btn btn--p">Start</button>
    <button id="stopBtn" class="btn btn--d" disabled>Stop</button>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <h3>Mode</h3>
    <div class="row">
      <label class="chip-inp"><input type="radio" name="mode" value="1d" checked> 1D Barcodes</label>
      <label class="chip-inp"><input type="radio" name="mode" value="2d"> 2D (QR + Data Matrix)</label>
    </div>

    <h3>Scan Control</h3>
    <div class="row">
      <label class="chip-inp"><input type="radio" name="arm" value="trigger" checked> Trigger (recommended)</label>
      <label class="chip-inp"><input type="radio" name="arm" value="continuous"> Continuous</label>
    </div>

    <h3>Camera</h3>
    <div class="row">
      <label class="subtle">Device</label>
      <select id="cameraSelect" class="control"></select>
      <span class="chip" id="camInfo">No camera selected</span>
    </div>
    <div class="row">
      <label class="chip-inp"><input type="checkbox" id="preferBack" checked> Prefer back camera when unknown</label>
    </div>

    <h3 style="margin-top:14px;">1D Decoding (Quagga2)</h3>
    <div class="subtle">Enable readers:</div>
    <div id="readers1d" class="chips">
      <label class="chip-inp"><input type="checkbox" value="code_128_reader" checked> CODE_128</label>
      <label class="chip-inp"><input type="checkbox" value="ean_reader" checked> EAN-13</label>
      <label class="chip-inp"><input type="checkbox" value="ean_8_reader" checked> EAN-8</label>
      <label class="chip-inp"><input type="checkbox" value="upc_reader" checked> UPC-A</label>
      <label class="chip-inp"><input type="checkbox" value="upc_e_reader" checked> UPC-E</label>
      <label class="chip-inp"><input type="checkbox" value="code_39_reader"> CODE_39</label>
      <label class="chip-inp"><input type="checkbox" value="code_93_reader"> CODE_93</label>
      <label class="chip-inp"><input type="checkbox" value="i2of5_reader"> ITF</label>
      <label class="chip-inp"><input type="checkbox" value="codabar_reader"> Codabar</label>
    </div>
    <div class="row">
      <label class="chip-inp"><input type="checkbox" id="tryHarder" checked> Try harder</label>
      <label class="chip-inp"><input type="checkbox" id="beep1d" checked> Beep / haptic</label>
    </div>

    <h3 style="margin-top:14px;">2D Decoding (ZXing)</h3>
    <p class="subtle">Restricted to <strong>QR</strong> and <strong>Data Matrix</strong>. In Trigger mode, press <b>Trigger</b> to arm for 3s.</p>
    <div class="row"><label class="chip-inp"><input type="checkbox" id="beep2d" checked> Beep / haptic</label></div>

    <div id="statusBox" class="status">Idle</div>
    <p class="subtle">Tip: iOS requires HTTPS (Netlify) or localhost (iHost) for camera access.</p>
  </section>

  <section class="card">
    <div class="video-card">
      <!-- 1D target -->
      <div id="viewport" class="viewport"></div>
      <!-- 2D stream -->
      <video id="video2d" class="viewport" playsinline muted style="display:none"></video>

      <!-- overlay (reticle only) -->
      <canvas id="overlay" class="overlay"></canvas>

      <div class="trigger">
        <button id="triggerBtn" class="btn btn--p">ðŸŽ¯ Trigger (3s)</button>
        <span id="armedBadge" class="armed" hidden>ARMED</span>
        <span id="statusText" class="subtle">Idle</span>
      </div>
    </div>

    <div style="display:grid;gap:12px;margin-top:12px;">
      <div class="card">
        <h3>Recent Scans</h3>
        <div id="results" class="results"></div>
      </div>
      <div class="card">
        <h3>Scans Table</h3>
        <div class="table-wrap" role="region" aria-label="Scans (swipe to scroll)">
          <table id="scanTable">
            <thead><tr><th style="width:150px">Type</th><th>Code</th><th style="width:90px">Time</th></tr></thead>
            <tbody id="scanBody"><tr><td colspan="3" class="center subtle">No scans yet</td></tr></tbody>
          </table>
        </div>
        <div class="row" style="justify-content:flex-end;margin-top:10px;">
          <button id="clearBtn" class="btn btn--d">Clear Table</button>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
(() => {
  const $=s=>document.querySelector(s);

  // UI refs
  const startBtn=$('#startBtn'), stopBtn=$('#stopBtn'), triggerBtn=$('#triggerBtn');
  const permBtn=$('#permBtn'), refreshBtn=$('#refreshBtn');
  const cameraSel=$('#cameraSelect'), camInfo=$('#camInfo'), preferBack=$('#preferBack');
  const readers1d=$('#readers1d'), tryHarder=$('#tryHarder'), beep1d=$('#beep1d'), beep2d=$('#beep2d');
  const viewport=$('#viewport'), video2d=$('#video2d'), overlay=$('#overlay'), octx=overlay.getContext('2d');
  const results=$('#results'), tbody=$('#scanBody'), armedBadge=$('#armedBadge'), statusText=$('#statusText'), statusBox=$('#statusBox');

  // Modes
  let codeMode='1d'; // '1d' or '2d'
  document.querySelectorAll('input[name="mode"]').forEach(r=>{
    r.addEventListener('change',async (e)=>{ codeMode=e.target.value; await restart(); });
  });
  let controlMode='trigger'; // 'trigger' or 'continuous'
  document.querySelectorAll('input[name="arm"]').forEach(r=>{
    r.addEventListener('change',(e)=>{ controlMode=e.target.value; setArmed(controlMode==='continuous'); });
  });

  // State
  let ARMED=(controlMode==='continuous');
  let armTimer=null, last={code:'',t:0}, DEDUPE=2500, LOCK=false;
  let currentDeviceId = localStorage.getItem('scanner.devId') || '';

  // Utils
  async function beep(){
    try{
      const ctx=new (window.AudioContext||window.webkitAudioContext)();
      const o=ctx.createOscillator(); const g=ctx.createGain();
      o.type='sine'; o.frequency.value=880;
      o.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(0.001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.01);
      g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.15);
      o.start(); o.stop(ctx.currentTime+0.16);
      if('vibrate' in navigator) navigator.vibrate(20);
    }catch{}
  }
  function ts(){ const d=new Date(); return d.toLocaleTimeString(); }
  function isDupe(code){ const now=Date.now(); if(code===last.code && now-last.t<DEDUPE) return true; last={code, t:now}; return false; }

  function setStatus(msg, ok=false, err=false){
    statusBox.textContent = msg;
    statusBox.className = 'status ' + (err?'status--err': ok?'status--ok':'');
    statusText.textContent = msg;
  }

  // Results
  function onDecode(type, code, doBeep){
    if(LOCK) return;
    if(controlMode==='trigger'){ setArmed(false); } // disarm immediately
    LOCK=true; setTimeout(()=>LOCK=false, 350);     // guard against duplicate callbacks
    if(doBeep) beep();

    const div=document.createElement('div');
    div.className='badge';
    div.textContent=`${type}: ${code}`;
    results.prepend(div);
    while(results.children.length>6) results.lastChild.remove();

    if(tbody.children.length && tbody.children[0].querySelector('.center')) tbody.innerHTML='';
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${type}</td><td>${code}</td><td>${ts()}</td>`;
    tbody.prepend(tr);

    setStatus(`Captured (${type})`, true, false);
  }
  $('#clearBtn').addEventListener('click', ()=>{ tbody.innerHTML='<tr><td colspan="3" class="center subtle">No scans yet</td></tr>'; results.innerHTML=''; });

  // Permission + cameras
  async function ensurePermission(){
    try{
      const tmp=await navigator.mediaDevices.getUserMedia({video:true,audio:false});
      tmp.getTracks().forEach(t=>t.stop());
      setStatus('Permission granted', true, false);
    }catch(e){ setStatus('Permission error: '+(e?.message||e), false, true); }
  }
  async function listCameras(){
    const devs=await navigator.mediaDevices.enumerateDevices();
    const vids=devs.filter(d=>d.kind==='videoinput');
    cameraSel.innerHTML='';
    vids.forEach((d,i)=>{
      const o=document.createElement('option');
      o.value=d.deviceId; o.textContent=d.label || `Camera ${i+1}`;
      cameraSel.appendChild(o);
    });
    if(currentDeviceId && [...cameraSel.options].some(o=>o.value===currentDeviceId)){
      cameraSel.value=currentDeviceId;
    }else if(preferBack.checked){
      const back=[...cameraSel.options].find(o=>/back|rear|environment/i.test(o.textContent));
      if(back) cameraSel.value=back.value;
    }
    currentDeviceId = cameraSel.value || currentDeviceId || '';
    camInfo.textContent = cameraSel.selectedOptions[0]?.textContent || 'No camera selected';
    localStorage.setItem('scanner.devId', currentDeviceId || '');
  }
  cameraSel.addEventListener('change', async ()=>{ currentDeviceId=cameraSel.value; await restart(); });

  // Constraints + auto settings (best-effort)
  function baseConstraints(){ return { width:{ideal:1920}, height:{ideal:1080}, frameRate:{ideal:30} }; }
  function fallbackConstraints(){
    return [
      { width:{ideal:1920}, height:{ideal:1080}, frameRate:{ideal:30} },
      { width:{ideal:1280}, height:{ideal:720},  frameRate:{ideal:30} },
      { width:{ideal:640},  height:{ideal:480},  frameRate:{ideal:24} },
    ];
  }
  function buildConstraints(){
    const id = cameraSel.value || currentDeviceId;
    const base = baseConstraints();
    if(id){ return { deviceId:{ exact:id }, ...base }; }
    return { facingMode: (preferBack.checked?'environment':'user'), ...base };
  }
  async function applyAuto(track){
    try{
      const caps = track.getCapabilities?.() || {};
      const adv = [];
      if(caps.focusMode && caps.focusMode.includes('continuous')) adv.push({ focusMode:'continuous' });
      if(caps.exposureMode && caps.exposureMode.includes('continuous')) adv.push({ exposureMode:'continuous' });
      if(caps.whiteBalanceMode && caps.whiteBalanceMode.includes('continuous')) adv.push({ whiteBalanceMode:'continuous' });
      if(caps.zoom){ const z=Math.min(caps.zoom.max||1, Math.max(caps.zoom.min||1, 1.3)); adv.push({ zoom:z }); }
      if(adv.length) await track.applyConstraints({ advanced: adv });
    }catch{}
  }

  // Overlay
  function sizeOverlay(){
    const el = (codeMode==='2d') ? video2d : viewport;
    overlay.width  = el.offsetWidth || overlay.clientWidth || 0;
    overlay.height = el.offsetHeight || el.clientHeight || 0;
  }
  function clearOverlay(){ octx.clearRect(0,0,overlay.width,overlay.height); }
  function drawReticle(){
    clearOverlay();
    const w=overlay.width, h=overlay.height;
    const rw=w*0.55, rh=h*0.55;
    const x=(w-rw)/2, y=(h-rh)/2;
    octx.strokeStyle = ARMED? 'lime' : 'rgba(173,216,230,.9)';
    octx.lineWidth = 2;
    octx.strokeRect(x,y,rw,rh);
  }

  // Arm / Trigger
  function setArmed(v){
    ARMED=v;
    armedBadge.hidden=!v || controlMode==='continuous';
    triggerBtn.textContent = (controlMode==='continuous') ? 'ðŸŽ¯ Continuous' : (v?'ðŸŽ¯ Armed (3s)':'ðŸŽ¯ Trigger (3s)');
    statusText.textContent = v ? 'Armed' : (controlMode==='continuous'?'Continuous':'Idle');
    if(armTimer){ clearTimeout(armTimer); armTimer=null; }
    if(controlMode==='trigger' && v){ armTimer=setTimeout(()=>setArmed(false), 3000); }
    drawReticle();
  }
  triggerBtn.addEventListener('click', ()=>{
    if(controlMode==='continuous'){ setStatus('Already in continuous mode'); return; }
    setArmed(true);
  });

  // 1D (Quagga) with fallbacks
  async function start1D(){
    await stop2D();
    sizeOverlay(); drawReticle();
    setStatus('Starting 1Dâ€¦');
    const cfgs = fallbackConstraints();
    for (let i=0;i<cfgs.length;i++){
      try{
        await initQuagga({ constraintsOverride: cfgs[i] });
        setStatus('1D ready', true, false);
        return;
      }catch(e){
        console.warn('Quagga init failed @', cfgs[i], e);
        if(i===cfgs.length-1){ throw e; }
      }
    }
  }
  function initQuagga({ constraintsOverride }){
    return new Promise((resolve,reject)=>{
      const constraints = buildConstraints();
      const merged = { ...constraints, ...constraintsOverride };
      Quagga.init({
        locate: tryHarder.checked,
        inputStream: { type:'LiveStream', target: viewport, constraints: merged },
        numOfWorkers: 0,
        locator:{ patchSize:'medium', halfSample:true },
        decoder: { readers: get1DReaders() }
      }, async err=>{
        if(err){ reject(err); return; }

        Quagga.onProcessed(()=> drawReticle());
        Quagga.onDetected(res=>{
          const active = (controlMode==='continuous') ? true : ARMED;
          if(!active) return;
          const code=res?.codeResult?.code;
          const fmt=(res?.codeResult?.format||'').toUpperCase();
          if(!code || isDupe(code)) return;
          onDecode(fmt || '1D', code, beep1d.checked);
        });

        Quagga.start().then(async ()=>{
          // apply AF/AE/AWB
          const track = Quagga.CameraAccess?.getActiveTrack?.();
          if(track) await applyAuto(track);
          startBtn.disabled=true; stopBtn.disabled=false;
          setArmed(controlMode==='continuous');
          resolve();
        }).catch(reject);
      });
    });
  }
  async function stop1D(){
    try{ Quagga.offProcessed(); Quagga.offDetected(); }catch{}
    try{ Quagga.stop(); }catch{}
    const v = viewport.querySelector('video'); if(v){ try{ v.srcObject?.getTracks?.().forEach(t=>t.stop()); }catch{} }
  }
  function get1DReaders(){ return [...readers1d.querySelectorAll('input:checked')].map(i=>i.value); }

  // 2D (ZXing) with fallbacks
  let reader2d=null, stream2d=null, raf2d=null;
  function ZX(){ return window.ZXing || window.ZXingBrowser || {}; }

  async function getStream2d(){
    const bases = fallbackConstraints();
    for (let i=0;i<bases.length;i++){
      try{
        const id = cameraSel.value || currentDeviceId;
        const base = bases[i];
        const cons = id ? { video:{ deviceId:{exact:id}, ...base }, audio:false }
                        : { video:{ facingMode:(preferBack.checked?'environment':'user'), ...base }, audio:false };
        return await navigator.mediaDevices.getUserMedia(cons);
      }catch(e){
        if(i===bases.length-1) throw e;
      }
    }
  }

  async function start2D(){
    await stop1D();
    video2d.style.display='block'; viewport.style.display='none';
    sizeOverlay(); drawReticle();
    setStatus('Starting 2Dâ€¦');

    stream2d = await getStream2d();
    video2d.srcObject = stream2d; video2d.setAttribute('playsinline',''); video2d.muted=true;
    await video2d.play().catch(()=>{});
    const track = stream2d.getVideoTracks?.()[0]; if(track) await applyAuto(track);

    cancelAnimationFrame(raf2d);
    const loop=()=>{ drawReticle(); raf2d=requestAnimationFrame(loop); }; loop();

    const Z=ZX();
    const BMR = Z.BrowserMultiFormatReader || Z.BrowserQRCodeReader;
    const BF  = Z.BarcodeFormat, H = Z.DecodeHintType;
    if(!BMR||!BF||!H){ setStatus('ZXing not available', false, true); return; }

    const hints=new Map();
    hints.set(H.POSSIBLE_FORMATS, [BF.QR_CODE,BF.DATA_MATRIX].filter(Boolean));
    hints.set(H.TRY_HARDER, true);
    reader2d = new BMR(hints);

    reader2d.decodeFromVideoElementContinuously(video2d,(res,err)=>{
      const active = (controlMode==='continuous') ? true : ARMED;
      if(!active) return;
      if(res){
        const code = (typeof res.getText==='function') ? res.getText() : (res.text||'');
        let fmt='QR_CODE';
        try{ const f=(typeof res.getBarcodeFormat==='function')?String(res.getBarcodeFormat()):(res.format||''); if(f) fmt=f; }catch{}
        if(!code || isDupe(code)) return;
        onDecode(fmt, code, beep2d.checked);
      }
    });

    startBtn.disabled=true; stopBtn.disabled=false;
    setArmed(controlMode==='continuous');
    setStatus('2D ready', true, false);
  }

  async function stop2D(){
    try{ reader2d?.reset?.(); }catch{}
    try{ if(stream2d){ stream2d.getTracks().forEach(t=>t.stop()); stream2d=null; } }catch{}
    cancelAnimationFrame(raf2d); video2d.srcObject=null; video2d.style.display='none'; viewport.style.display='block'; clearOverlay();
  }

  // Lifecycle
  async function start(){ try{ if(codeMode==='2d') await start2D(); else await start1D(); }catch(e){ setStatus('Start error: '+(e?.message||e), false, true); } }
  async function stop(){ await stop1D(); await stop2D(); startBtn.disabled=false; stopBtn.disabled=true; setArmed(controlMode==='continuous' ? true : false); setStatus('Stopped'); }
  async function restart(){ await stop(); await start(); }

  // Buttons
  startBtn.addEventListener('click', start);
  stopBtn.addEventListener('click', stop);
  permBtn.addEventListener('click', ensurePermission);
  refreshBtn.addEventListener('click', async ()=>{ await listCameras(); });

  // Init
  window.addEventListener('resize', ()=>{ sizeOverlay(); drawReticle(); });
  (async ()=>{ try{ await ensurePermission(); await listCameras(); sizeOverlay(); drawReticle(); }catch(e){} })();
})();
</script>
</body>
</html>
