<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>iOS Scanner â€¢ 1D (Quagga2) + 2D QR (ZXing)</title>

  <!-- Libraries -->
  <!-- Quagga2 for 1D barcodes -->
  <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.4/dist/quagga.js"></script>
  <!-- ZXing for 2D (QR) only -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script src="https://unpkg.com/@zxing/browser@latest"></script>

  <style>
    :root{
      --bg:#0b1020; --card:#11172b; --text:#e9ecf1; --muted:#aab2c7;
      --primary:#4fb3ff; --danger:#ff5c7a; --border:#1f2a45; --good:#2ecc71;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,system-ui,Inter,Roboto,Arial;background:var(--bg);color:var(--text)}
    .topbar{
      display:flex;justify-content:space-between;align-items:center;
      padding:12px 16px;background:#0f1527;border-bottom:1px solid var(--border)
    }
    .brand{font-weight:800}
    .btn{border:none;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn--primary{background:var(--primary);color:#001222}
    .btn--danger{background:var(--danger);color:#160003}
    .btn--ghost{background:transparent;border:1px solid var(--border);color:var(--text)}

    .wrap{display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:16px;max-width:1100px;margin:0 auto}
    @media (max-width:900px){ .wrap{grid-template-columns:1fr} }
    .card{
      background:var(--card);border:1px solid var(--border);border-radius:12px;
      padding:12px;box-shadow:0 12px 30px rgba(0,0,0,.25)
    }
    h3{margin:6px 0 10px 0}
    .row{display:flex;align-items:center;gap:10px;margin:8px 0;flex-wrap:wrap}
    .chips{display:flex;flex-wrap:wrap;gap:6px}
    .chip{background:#1a223a;padding:6px 8px;border-radius:999px}
    .control{
      width:auto;min-width:160px;background:#0d1429;color:var(--text);padding:8px 10px;
      border-radius:10px;border:1px solid var(--border)
    }
    .subtle{color:var(--muted);font-size:14px}

    .video-card{
      background:#000;border-radius:12px;overflow:hidden;border:1px solid var(--border);
      position:relative
    }
    /* Compact responsive camera window */
    .viewport{width:100%;height:clamp(220px, 40vh, 420px)}
    .overlay{position:absolute;inset:0;pointer-events:none}

    .trigger-bar{
      position:absolute;left:0;right:0;bottom:0;
      display:flex;gap:10px;align-items:center;justify-content:center;
      padding:10px;
      background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.55));
      backdrop-filter:saturate(1.2) blur(6px);
      border-top:1px solid rgba(255,255,255,.08)
    }
    .armed{
      display:inline-flex;align-items:center;justify-content:center;
      padding:6px 10px;border-radius:999px;border:1px solid rgba(46,204,113,.4);
      background:rgba(46,204,113,.15);color:var(--good);font-weight:700;letter-spacing:.3px
    }
    .status{font-size:13px}
    .muted{color:var(--muted)}
    .results{display:grid;gap:6px}
    .badge{background:#15223f;border:1px solid var(--border);border-radius:10px;padding:8px 10px}

    .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:10px}
    .table{width:100%;border-collapse:collapse;background:#0d1429}
    .table th,.table td{border-bottom:1px solid var(--border);padding:10px 12px;white-space:nowrap}
    .table thead th{position:sticky;top:0;background:#0f1527;text-align:left;font-size:12px;color:var(--muted)}
    .center{text-align:center}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">ðŸ“· iOS Scanner â€¢ 1D (Quagga2) + 2D QR (ZXing)</div>
    <div class="actions">
      <button id="startBtn" class="btn btn--primary">Start</button>
      <button id="stopBtn"  class="btn btn--danger"  disabled>Stop</button>
    </div>
  </header>

  <main class="wrap">
    <!-- Controls -->
    <section class="card">
      <h3>Mode</h3>
      <div class="row">
        <label class="chip"><input type="radio" name="mode" value="1d" checked> 1D Barcodes</label>
        <label class="chip"><input type="radio" name="mode" value="qr"> 2D (QR only)</label>
      </div>

      <h3>Camera</h3>
      <div class="row">
        <label>Device</label>
        <select id="cameraSelect" class="control"></select>
      </div>
      <div class="row">
        <label><input type="checkbox" id="envFacing" checked> Prefer back camera</label>
      </div>

      <h3 style="margin-top:14px;">Decoding</h3>

      <!-- 1D readers (Quagga2) -->
      <div id="readers1dWrap">
        <div class="row"><div class="subtle">Enable 1D readers:</div></div>
        <div id="readers1d" class="chips">
          <label class="chip"><input type="checkbox" value="code_128_reader" checked> CODE_128</label>
          <label class="chip"><input type="checkbox" value="ean_reader" checked> EAN-13</label>
          <label class="chip"><input type="checkbox" value="ean_8_reader" checked> EAN-8</label>
          <label class="chip"><input type="checkbox" value="upc_reader" checked> UPC-A</label>
          <label class="chip"><input type="checkbox" value="upc_e_reader" checked> UPC-E</label>
          <label class="chip"><input type="checkbox" value="code_39_reader"> CODE_39</label>
          <label class="chip"><input type="checkbox" value="code_93_reader"> CODE_93</label>
          <label class="chip"><input type="checkbox" value="i2of5_reader"> ITF</label>
          <label class="chip"><input type="checkbox" value="codabar_reader"> Codabar</label>
        </div>
        <div class="row">
          <label><input type="checkbox" id="tryHarder" checked> Try harder</label>
          <label><input type="checkbox" id="beep" checked> Beep / haptic on success</label>
        </div>
      </div>

      <!-- QR note (ZXing) -->
      <div id="readers2dWrap" style="display:none">
        <p class="subtle">QR scanning uses ZXing Browser for best iOS results.</p>
        <div class="row"><label><input type="checkbox" id="beep2d" checked> Beep / haptic on success</label></div>
      </div>

      <p class="subtle">Tip: iOS requires HTTPS (Netlify) or localhost (iHost) for camera access.</p>
    </section>

    <!-- Viewer + results -->
    <section class="card">
      <div class="video-card">
        <div id="viewport" class="viewport"></div>   <!-- for Quagga (1D) -->
        <video id="qrVideo" class="viewport" playsinline style="display:none"></video> <!-- for ZXing (QR) -->
        <canvas id="overlay" class="overlay"></canvas>

        <div class="trigger-bar">
          <button id="triggerBtn" class="btn btn--primary">ðŸŽ¯ Trigger (3s)</button>
          <span id="armedBadge" class="armed" hidden>ARMED</span>
          <span id="statusText" class="status muted">Idle</span>
        </div>
      </div>

      <div style="display:grid; gap:12px; margin-top:12px;">
        <div class="card">
          <h3>Recent Scans</h3>
          <div id="results" class="results"></div>
        </div>

        <div class="card">
          <h3>Scans Table</h3>
          <div class="table-wrap" role="region" aria-label="Scans (swipe to scroll)">
            <table class="table" id="scanTable">
              <thead>
                <tr><th style="width:150px">Type</th><th>Code</th><th style="width:90px">Time</th></tr>
              </thead>
              <tbody id="scanTbody">
                <tr><td colspan="3" class="center muted">No scans yet</td></tr>
              </tbody>
            </table>
          </div>
          <div class="row" style="justify-content:flex-end; margin-top:10px;">
            <button id="clearTable" class="btn btn--danger">Clear Table</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- tiny inline beep (base64) -->
  <template id="beepTpl">
    <audio id="beepAudio" preload="auto">
      <source type="audio/mp3" src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQCA//////////8AAA"/>
    </audio>
  </template>

  <script>
    // Unified controller for 1D (Quagga2) and QR (ZXing)
    const $ = s => document.querySelector(s);

    // UI refs
    const startBtn   = $('#startBtn');
    const stopBtn    = $('#stopBtn');
    const triggerBtn = $('#triggerBtn');
    const armedBadge = $('#armedBadge');
    const statusText = $('#statusText');
    const cameraSel  = $('#cameraSelect');
    const envFacing  = $('#envFacing');

    const readers1dWrap = $('#readers1dWrap');
    const readers2dWrap = $('#readers2dWrap');
    const readers1d = $('#readers1d');
    const tryHarder = $('#tryHarder');
    const beep1dChk = $('#beep');
    const beep2dChk = $('#beep2d');

    const viewport   = $('#viewport'); // for Quagga
    const qrVideo    = $('#qrVideo');  // for ZXing
    const overlay    = $('#overlay');
    const octx       = overlay.getContext('2d');

    const results    = $('#results');
    const tbody      = $('#scanTbody');
    const clearBtn   = $('#clearTable');

    // Mode
    let mode = '1d'; // '1d' or 'qr'
    const radios = document.querySelectorAll('input[name="mode"]');

    // State
    let ARMED = false;
    let armTimer = null;
    let last = { code:'', t:0 };
    const DEDUPE_MS = 2000;

    // ZXing QR reader
    let zxingReader = null;
    let qrActive = false;

    function resizeOverlay() {
      overlay.width  = (mode==='qr' ? qrVideo.offsetWidth : viewport.offsetWidth);
      overlay.height = (mode==='qr' ? qrVideo.offsetHeight : viewport.offsetHeight);
    }
    function dupe(code) {
      const now = Date.now();
      if (code === last.code && now - last.t < DEDUPE_MS) return true;
      last = { code, t: now }; return false;
    }
    function beep(enabled) {
      if (!enabled) return;
      if ('vibrate' in navigator) navigator.vibrate(20);
      let a = document.getElementById('beepAudio');
      if (!a) {
        const frag = document.getElementById('beepTpl').content.cloneNode(true);
        document.body.appendChild(frag);
        a = document.getElementById('beepAudio');
      }
      a.play().catch(()=>{});
    }
    function addBadge(fmt, code) {
      const el = document.createElement('div');
      el.className = 'badge';
      el.textContent = `${fmt}: ${code}`;
      results.prepend(el);
    }
    function addRow(fmt, code) {
      const first = tbody.firstElementChild;
      if (first && first.children.length === 1) tbody.removeChild(first);
      const tr = document.createElement('tr');
      const tdT = document.createElement('td');
      const tdC = document.createElement('td');
      const tdD = document.createElement('td');
      tdT.textContent = fmt || 'UNKNOWN';
      tdC.textContent = code || '';
      tdD.textContent = new Date().toLocaleTimeString();
      tr.appendChild(tdT); tr.appendChild(tdC); tr.appendChild(tdD);
      tbody.prepend(tr);
    }
    function setArmed(on) {
      ARMED = !!on;
      armedBadge.hidden = !ARMED;
      statusText.textContent = ARMED ? 'Armed (waiting for code)â€¦' : 'Idle';
      triggerBtn.disabled = ARMED;
    }
    function buildConstraints() {
      const id = cameraSel && cameraSel.value;
      if (id) return { deviceId: { exact: id }, width:{ideal:1280}, height:{ideal:720} };
      return { facingMode: envFacing.checked ? 'environment' : 'user', width:{ideal:1280}, height:{ideal:720} };
    }

    /* ---------------- 1D (Quagga2) ---------------- */
    function get1DReaders() {
      return Array.from(readers1d.querySelectorAll('input:checked')).map(i => i.value);
    }
    function buildQuaggaConfig() {
      return {
        locate: tryHarder.checked,
        inputStream: { type:'LiveStream', target: viewport, constraints: buildConstraints() },
        numOfWorkers: 0, // iOS-friendly
        locator: { patchSize: 'medium', halfSample: true },
        decoder: { readers: get1DReaders() }
      };
    }
    async function start1D() {
      if (Quagga.initialized) await stop1D();
      resizeOverlay();
      return new Promise((resolve,reject)=>{
        Quagga.init(buildQuaggaConfig(), err=>{
          if (err) { console.error(err); statusText.textContent='Init error'; reject(err); return; }
          Quagga.initialized = true;

          Quagga.onProcessed(res=>{
            octx.clearRect(0,0,overlay.width,overlay.height);
            if (res?.box) {
              octx.strokeStyle = ARMED ? 'lime' : 'rgba(173,216,230,.85)';
              octx.lineWidth = 3;
              octx.beginPath();
              res.box.forEach((p,i)=> i?octx.lineTo(p.x,p.y):octx.moveTo(p.x,p.y));
              octx.closePath(); octx.stroke();
            }
          });

          Quagga.onDetected(res=>{
            if (!ARMED) return;
            const code = res?.codeResult?.code;
            const fmt  = (res?.codeResult?.format || '').toUpperCase();
            if (!code || dupe(code)) return;
            addBadge(fmt, code);
            addRow(fmt, code);
            beep(beep1dChk.checked);
            clearTimeout(armTimer); setArmed(false);
          });

          Quagga.start();
          startBtn.disabled = true; stopBtn.disabled = false;
          setArmed(false); statusText.textContent='Ready';
          resolve();
        });
      });
    }
    async function stop1D() {
      try { Quagga.offProcessed(); Quagga.offDetected(); } catch {}
      try { Quagga.stop(); } catch {}
      Quagga.initialized = false;
    }

    /* ---------------- 2D (QR via ZXing) ---------------- */
    function getZX() {
      // Support either global namespace, depending on build
      return window.ZXingBrowser?.BrowserQRCodeReader
             ? new window.ZXingBrowser.BrowserQRCodeReader()
             : new (window.ZXing?.BrowserQRCodeReader || function(){ throw new Error('ZXing not found'); })();
    }
    async function startQR() {
      resizeOverlay();
      qrVideo.style.display = '';
      viewport.style.display = 'none';

      // stop any previous instance
      await stopQR();
      zxingReader = getZX();

      const deviceId = cameraSel?.value || undefined;
      // Use ZXing continuous decode; ignore results unless ARMED
      await zxingReader.decodeFromVideoDevice(deviceId ?? null, qrVideo, (result, err) => {
        // draw a soft reticle so user sees it's active
        octx.clearRect(0,0,overlay.width,overlay.height);
        octx.strokeStyle = ARMED ? 'lime' : 'rgba(173,216,230,.85)';
        octx.lineWidth = 2;
        octx.strokeRect(overlay.width*0.25, overlay.height*0.25, overlay.width*0.5, overlay.height*0.5);

        if (!ARMED) return;
        if (result?.text) {
          const code = String(result.text).trim();
          if (!code || dupe(code)) return;
          addBadge('QR_CODE', code);
          addRow('QR_CODE', code);
          beep(beep2dChk.checked);
          clearTimeout(armTimer); setArmed(false);
        }
      });
      qrActive = true;
      startBtn.disabled = true; stopBtn.disabled = false;
      setArmed(false); statusText.textContent='Ready';
    }
    async function stopQR() {
      try { zxingReader?.reset(); } catch {}
      try {
        const s = qrVideo.srcObject;
        if (s) { s.getTracks().forEach(t=>t.stop()); qrVideo.srcObject = null; }
      } catch {}
      qrActive = false;
      qrVideo.style.display = 'none';
      viewport.style.display = '';
      octx.clearRect(0,0,overlay.width,overlay.height);
    }

    /* ---------------- Shared control ---------------- */
    async function start() {
      if (mode === 'qr') { await stop1D(); await startQR(); }
      else { await stopQR(); await start1D(); }
    }
    async function stop() {
      await stop1D(); await stopQR();
      startBtn.disabled = false; stopBtn.disabled = true;
      setArmed(false); statusText.textContent='Stopped';
    }
    function armFor(ms=3000) {
      clearTimeout(armTimer); setArmed(true);
      armTimer = setTimeout(()=> setArmed(false), ms);
    }

    // Events
    startBtn.addEventListener('click', start);
    stopBtn .addEventListener('click', stop);
    triggerBtn.addEventListener('click', ()=> armFor(3000));
    clearBtn.addEventListener('click', ()=>{
      tbody.innerHTML = '<tr><td colspan="3" class="center muted">No scans yet</td></tr>';
      results.innerHTML = '';
    });

    // Mode switch
    document.querySelectorAll('input[name="mode"]').forEach(r=>{
      r.addEventListener('change', async (e)=>{
        mode = e.target.value;
        // toggle settings panels
        readers1dWrap.style.display = (mode==='1d') ? '' : 'none';
        readers2dWrap.style.display = (mode==='qr') ? '' : 'none';
        if (startBtn.disabled) { // running
          await start(); // restart into new mode
        } else {
          // switch preview elements so overlay sizes correctly
          qrVideo.style.display = (mode==='qr') ? '' : 'none';
          viewport.style.display = (mode==='qr') ? 'none' : '';
          resizeOverlay();
        }
      });
    });

    // Refresh pipeline on reader / facing / device change if running
    readers1d.addEventListener('change', async ()=> { if (startBtn.disabled && mode==='1d') await start(); });
    tryHarder.addEventListener('change', async ()=> { if (startBtn.disabled && mode==='1d') await start(); });
    envFacing.addEventListener('change', async ()=> { if (startBtn.disabled) await start(); });
    cameraSel .addEventListener('change', async ()=> { if (startBtn.disabled) await start(); });

    // Camera list (labels appear after permission)
    async function listCameras() {
      try {
        const devs = await navigator.mediaDevices.enumerateDevices();
        const vids = devs.filter(d=>d.kind==='videoinput');
        cameraSel.innerHTML = '';
        vids.forEach((d,i)=>{
          const o = document.createElement('option');
          o.value = d.deviceId;
          o.textContent = d.label || `Camera ${i+1}`;
          cameraSel.appendChild(o);
        });
      } catch {}
    }
    (async()=>{ try { await listCameras(); } catch {} })();

    // Keep overlay synced
    addEventListener('resize', ()=> { resizeOverlay(); });

    // Initial UI state
    readers1dWrap.style.display = '';
    readers2dWrap.style.display = 'none';
    resizeOverlay();
  </script>
</body>
</html>
