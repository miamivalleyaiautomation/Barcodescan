<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ScanSnap — ZXing WASM Demo</title>
  <meta name="theme-color" content="#0b0d12" />

  <!-- Single external dependency: zxing-wasm (IIFE, reader only).
       It auto-loads zxing_reader.wasm from jsDelivr. -->
  <script src="https://cdn.jsdelivr.net/npm/zxing-wasm@2.2.1/dist/iife/reader/index.js"></script>

  <style>
    :root{
      --bg:#0b0d12; --fg:#eef2f6; --muted:#a8b7cc;
      --pri:#4aa3ff; --pri2:#2e86ff;
      --ok:#00e676; --bad:#ff4d4d; --line:#283041; --card:#151b24;
    }
    html[data-theme="light"]{ --bg:#f7f9fc; --fg:#0f1722; --muted:#5a6a82; --card:#fff; --line:#dbe3f1; }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.45 system-ui, Segoe UI, Roboto, Helvetica, Arial}
    .wrap{padding:12px 12px 96px}
    .top{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    .top .title{font-weight:800}
    .row{display:flex;gap:8px}
    .row.stretch>*{flex:1}
    .btn{appearance:none;border:1px solid var(--line);background:var(--card);color:var(--fg);
         padding:12px;border-radius:12px;font-weight:700}
    .btn:active{transform:translateY(1px)}
    .btn.primary{border-color:transparent;background:linear-gradient(180deg,var(--pri),var(--pri2));color:#fff}
    .btn.ghost{background:transparent}
    .btn.pill{border-radius:999px;padding:8px 12px}
    .select,.input{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:var(--card);color:var(--fg)}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px}

    .video-wrap{position:relative;border-radius:16px;background:#000;border:1px solid var(--line);
      height:var(--cam-h,56.25vw);max-height:70vh;min-height:220px;margin:10px 0 8px;overflow:visible}
    video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000;opacity:0;transition:opacity .25s}
    video.on{opacity:1}
    .overlay{position:absolute;inset:0;pointer-events:none}
    .flash{position:absolute;inset:0;background:#fff;opacity:0;pointer-events:none}
    .flash.on{animation:flash-kf 180ms ease-out 1}
    .hud{position:absolute;left:8px;top:8px;display:flex;gap:6px;z-index:2}
    .trigger{position:absolute;left:12px;right:12px;bottom:10px;z-index:3;padding:16px 14px;font-size:18px;border-radius:16px;
      box-shadow:0 10px 28px rgba(46,134,255,.45);display:flex;flex-direction:column;align-items:center;gap:4px;text-align:center}
    .trigger[hidden]{display:none}
    .sub{opacity:.8;font-weight:600;font-size:13px}
    .glow-ok{box-shadow:0 0 0 3px rgba(0,230,118,.45), inset 0 0 24px rgba(0,230,118,.35)}
    .glow-bad{box-shadow:0 0 0 3px rgba(255,77,77,.45), inset 0 0 24px rgba(255,77,77,.35)}

    .status{margin:6px 2px 2px;font-weight:700}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px}
    .last{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .last .code{font:600 16px/1.2 ui-monospace, SFMono-Regular, Menlo, monospace;word-break:break-word}
    .last .qty{display:flex;align-items:center;gap:8px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:var(--card)}
    @keyframes flash-kf{0%{opacity:.98}100%{opacity:0}}
  </style>
</head>
<body>
  <main class="wrap">
    <div class="top">
      <div class="title">ScanSnap — ZXing WASM</div>
      <div style="margin-left:auto">
        <select id="theme" class="select" style="max-width:140px">
          <option value="dark">Dark</option><option value="light">Light</option>
        </select>
      </div>
    </div>

    <div class="panel">
      <div class="row stretch">
        <button id="btn-perm" class="btn ghost">Camera Permission</button>
        <button id="btn-open" class="btn primary" data-state="stopped">Start Camera</button>
      </div>
      <div class="row" style="margin-top:8px">
        <select id="camera" class="select"></select>
        <button id="btn-torch" class="btn" style="min-width:110px">Torch</button>
      </div>

      <div id="vw" class="video-wrap">
        <video id="video" playsinline muted></video>
        <canvas id="layer" class="overlay"></canvas>
        <div id="flash" class="flash"></div>

        <div class="hud">
          <span class="badge">ZXing WASM</span>
        </div>

        <button id="btn-scan" class="btn primary trigger" hidden disabled>
          <span class="label">Tap to Scan</span>
          <span id="last-line" class="sub">Last: —</span>
        </button>
      </div>

      <div id="status" class="status">Ready</div>

      <div id="last" class="card last" hidden>
        <div style="min-width:0">
          <div style="font-weight:700;color:var(--muted);font-size:13px">Last scanned</div>
          <div id="last-code" class="code">—</div>
          <div id="last-fmt" class="sub">—</div>
        </div>
        <div class="qty">
          <button id="q-dec" class="btn pill">−</button>
          <span id="q-val" style="min-width:28px;text-align:center;font-weight:800">1</span>
          <button id="q-inc" class="btn pill">＋</button>
        </div>
      </div>
    </div>

    <p style="opacity:.75;margin-top:10px">
      <small>
        Uses <code>zxing-wasm</code> (<em>fast C++ core compiled to WebAssembly</em>). One-shot manual trigger; supports 1D & 2D. Formats can be filtered and options tuned with <code>ReaderOptions</code>.  [oai_citation:1‡zxing-wasm.deno.dev](https://zxing-wasm.deno.dev/interfaces/full.ReaderOptions.html)
      </small>
    </p>
  </main>

  <script>
    // ===== UI helpers =====
    const $ = sel => document.querySelector(sel);
    const els = {
      theme: $('#theme'),
      vw:    $('#vw'),
      video: $('#video'),
      layer: $('#layer'),
      flash: $('#flash'),
      perm:  $('#btn-perm'),
      open:  $('#btn-open'),
      cam:   $('#camera'),
      torch: $('#btn-torch'),
      scan:  $('#btn-scan'),
      status:$('#status'),
      lastBox: $('#last'),
      lastLine: $('#last-line'),
      lastCode: $('#last-code'),
      lastFmt: $('#last-fmt'),
      qDec: $('#q-dec'), qVal: $('#q-val'), qInc: $('#q-inc'),
    };

    const S = {
      stream: null, track: null, running:false, lastCode:null, qty:1, torch:false,
      guardAt: 0,
    };

    function setTheme(v){ document.documentElement.setAttribute('data-theme', v==='light'?'light':'dark'); }
    els.theme.value = (localStorage.getItem('theme') || 'dark');
    setTheme(els.theme.value);
    els.theme.onchange = e => { setTheme(e.target.value); localStorage.setItem('theme', e.target.value); };

    function setStatus(t){ els.status.textContent = t; }
    function flash(){ els.flash.classList.remove('on'); void els.flash.offsetWidth; els.flash.classList.add('on'); }
    function glowOK(){ els.vw.classList.remove('glow-bad'); els.vw.classList.add('glow-ok'); setTimeout(()=>els.vw.classList.remove('glow-ok'), 900); }
    function glowBAD(){ els.vw.classList.remove('glow-ok'); els.vw.classList.add('glow-bad'); setTimeout(()=>els.vw.classList.remove('glow-bad'), 900); }
    function haptic(ok=true){ try{ navigator.vibrate?.(ok ? [15,35,15] : [60,60,60]); }catch{} }

    function fitLayer(){
      const w = els.video.videoWidth || els.vw.clientWidth;
      const h = els.video.videoHeight || els.vw.clientHeight;
      els.layer.width = w; els.layer.height = h;
    }
    window.addEventListener('resize', ()=> {
      const track = S.track; if (!track) return;
      const s = track.getSettings?.() || {};
      const ar = s.aspectRatio || (els.video.videoWidth && els.video.videoHeight ? els.video.videoWidth/els.video.videoHeight : 16/9);
      const target = Math.min(window.innerHeight * 0.70, window.innerWidth / ar);
      document.documentElement.style.setProperty('--cam-h', `${Math.max(target, 220)}px`);
    });

    // ===== Camera =====
    async function listCams(){
      const devices = await navigator.mediaDevices.enumerateDevices();
      const vids = devices.filter(d=> d.kind==='videoinput');
      els.cam.innerHTML = '';
      vids.forEach(v=>{
        const o = document.createElement('option');
        o.value = v.deviceId; o.textContent = v.label || 'Camera';
        els.cam.appendChild(o);
      });
      if (vids.length && !els.cam.value){ els.cam.value = vids[vids.length-1].deviceId; }
    }

    async function ensurePerm(){
      try{
        const s = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
        s.getTracks().forEach(t=>t.stop());
        await listCams();
        setStatus('Permission OK');
        return true;
      }catch(e){
        setStatus('Permission denied'); return false;
      }
    }

    async function startCamera(){
      const deviceId = els.cam.value || undefined;
      const constraints = {
        audio:false,
        video:{
          deviceId: deviceId ? { exact: deviceId } : undefined,
          facingMode: deviceId ? undefined : { ideal: 'environment' },
          width: { ideal: 1920 }, height:{ ideal: 1080 }
        }
      };
      S.stream = await navigator.mediaDevices.getUserMedia(constraints);
      els.video.srcObject = S.stream;
      await els.video.play();
      S.track = S.stream.getVideoTracks()[0] || null;
      els.video.classList.add('on');
      S.running = true;
      els.scan.hidden = false; els.scan.disabled = false;
      els.open.textContent = 'Stop Camera'; els.open.dataset.state = 'running';
      setStatus('Camera ready');
      fitLayer();
      window.dispatchEvent(new Event('resize'));
      const caps = S.track?.getCapabilities?.() || {};
      els.torch.style.display = caps.torch ? 'inline-block' : 'none';
    }

    async function stopCamera(){
      if (S.stream){ S.stream.getTracks().forEach(t=>t.stop()); }
      S.stream=null; S.track=null; S.running=false;
      els.video.pause(); els.video.srcObject=null; els.video.classList.remove('on');
      els.scan.hidden = true; els.scan.disabled = true;
      els.open.textContent = 'Start Camera'; els.open.dataset.state = 'stopped';
      setStatus('Camera stopped');
    }

    // ===== ZXing WASM (IIFE) =====
    // Docs: readBarcodes(ImageData|Blob, options) -> Promise<ReadResult[]>
    // Options: formats, tryHarder, maxNumberOfSymbols, etc. (ReaderOptions)   [oai_citation:2‡zxing-wasm.deno.dev](https://zxing-wasm.deno.dev/interfaces/full.ReaderOptions.html)
    const ZX = window.ZXingWASM;

    async function oneShotScan(){
      if (!S.running){ setStatus('Start camera first'); return; }
      els.scan.disabled = true;
      const label = els.scan.querySelector('.label');
      const prev = label.textContent;
      label.textContent = 'Scanning…';
      setStatus('Scanning…');

      // Draw current frame to ImageData
      const vw = els.video.videoWidth, vh = els.video.videoHeight;
      if (!vw || !vh){ label.textContent = prev; els.scan.disabled=false; setStatus('Video not ready'); return; }
      const ctx = els.layer.getContext('2d', { willReadFrequently:true });
      els.layer.width = vw; els.layer.height = vh;
      ctx.drawImage(els.video, 0, 0, vw, vh);
      const imgData = ctx.getImageData(0, 0, vw, vh);

      try{
        // Keep defaults (which already include tryHarder:true in ReaderOptions).
        // Limit to 1 symbol for speed.
        const results = await ZX.readBarcodes(imgData, { maxNumberOfSymbols: 1 });
        if (results.length){
          const r = results[0];
          const code = (r.text ?? '').trim();
          const fmt  = r.format ?? 'Unknown';
          S.lastCode = code; els.lastLine.textContent = `Last: ${code} (${fmt})`;
          els.lastCode.textContent = code; els.lastFmt.textContent = fmt;
          els.lastBox.hidden = false;

          // Feedback
          flash(); glowOK(); haptic(true);
          setStatus(`OK [${fmt}] ${code}`);
        } else {
          glowBAD(); haptic(false);
          setStatus('No code found');
        }
      }catch(e){
        glowBAD(); haptic(false);
        setStatus('Scan failed: ' + (e?.message || e));
      }finally{
        label.textContent = prev;
        els.scan.disabled = false;
      }
    }

    // ===== Torch toggle =====
    async function toggleTorch(){
      const caps = S.track?.getCapabilities?.(); if (!caps || !caps.torch) return;
      S.torch = !S.torch;
      try{ await S.track.applyConstraints({ advanced:[{ torch: S.torch }] }); }catch{}
    }

    // ===== Events =====
    els.perm.onclick = ensurePerm;
    els.open.onclick = async () => {
      const now = Date.now(); if (now - S.guardAt < 600) return; S.guardAt = now;
      els.open.disabled = true;
      try{
        if (S.running) await stopCamera(); else {
          if (!(await ensurePerm())) return;
          await startCamera();
        }
      } finally { setTimeout(()=> els.open.disabled=false, 250); }
    };
    els.cam.onchange = async ()=> { if (S.running){ await stopCamera(); await startCamera(); } };
    els.torch.onclick = toggleTorch;
    els.scan.onclick = oneShotScan;

    // Last scanned qty sample controls (for UX parity with your app)
    els.qInc.onclick = ()=>{ S.qty++; els.qVal.textContent = S.qty; };
    els.qDec.onclick = ()=>{ S.qty = Math.max(1, S.qty-1); els.qVal.textContent = S.qty; };

    // Init
    (async ()=>{
      try{ await ensurePerm(); await listCams(); }catch{}
      // Show trigger only after camera starts
      els.scan.hidden = true; els.scan.disabled = true;
    })();
  </script>
</body>
</html>
